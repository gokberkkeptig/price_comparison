
{% extends "base.html" %}

{% block head %}
    {{ super() }}
    <link rel="stylesheet" type="text/css" href="{{ url_for('static', filename='css/checkout.css') }}">
{% endblock %}

{% block content %}
<div class="container my-4">
    <h2>Your Shopping Cart</h2>
    <div id="cartContainer"></div>
    <div id="totalCostContainer"></div>
    <button id="clearCartButton" class="btn btn-danger">Clear Cart</button>

</div>

<script>
    document.getElementById('clearCartButton').addEventListener('click', function() {
        if (confirm('Are you sure you want to clear your cart?')) {
            localStorage.removeItem('cart');
            window.location.reload();
        }
    });
    
    document.addEventListener('DOMContentLoaded', function() {
        // Fetch cart from Local Storage
        let cart = JSON.parse(localStorage.getItem('cart')) || {};

        // If cart is empty
        if (Object.keys(cart).length === 0) {
            document.getElementById('cartContainer').innerHTML = '<p>Your cart is empty.</p>';
            return;
        }

        // Fetch product data from the server
        fetch('/get_cart_products', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ cart: cart })
        })
        .then(response => response.json())
        .then(data => {
            displayCartItems(data.products);
            calculateTotalCosts(data.products, data.stores);
        })
        .catch(error => {
            console.error('Error fetching cart products:', error);
        });

        function displayCartItems(products) {
            let cartContainer = document.getElementById('cartContainer');
            cartContainer.innerHTML = '';
        
            products.forEach(product => {
                let quantity = cart[product.product_id];
                let productDiv = document.createElement('div');
                productDiv.classList.add('cart-item');
        
                productDiv.innerHTML = `
                    <img src="${product.image_url}" alt="${product.name}" class="cart-item-image">
                    <div class="cart-item-details">
                        <h3>${product.name}</h3>
                        <p>Quantity: ${quantity}</p>
                    </div>
                `;
        
                cartContainer.appendChild(productDiv);
            });
        }
        

        function calculateTotalCosts(products, stores) {
            let totals = {};
            let storeItemAvailability = {};

            // Initialize totals and availability
            stores.forEach(store => {
                totals[store] = 0;
                storeItemAvailability[store] = {
                    available: [],
                    unavailable: []
                };
            });

            products.forEach(product => {
                let quantity = cart[product.product_id];

                stores.forEach(store => {
                    // Find if the product is available at this store
                    let priceInfo = product.prices.find(p => p.store === store);

                    if (priceInfo) {
                        // Product is available
                        totals[store] += priceInfo.price * quantity;
                        storeItemAvailability[store].available.push({
                            name: product.name,
                            price: priceInfo.price,
                            quantity: quantity
                        });
                    } else {
                        // Product is not available
                        storeItemAvailability[store].unavailable.push(product.name);
                    }
                });
            });

            displayTotalCosts(totals, storeItemAvailability);
        }

        function displayTotalCosts(totals, storeItemAvailability) {
            let totalCostContainer = document.getElementById('totalCostContainer');
            totalCostContainer.innerHTML = '<h3>Total Cost per Supermarket:</h3>';

            for (let store in totals) {
                let storeDiv = document.createElement('div');
                storeDiv.classList.add('store-summary');

                let totalCost = totals[store].toFixed(2);

                storeDiv.innerHTML = `
                    <h4>${store} - Total Cost: €${totalCost}</h4>
                `;

                let availableItems = storeItemAvailability[store].available;
                let unavailableItems = storeItemAvailability[store].unavailable;

                if (availableItems.length > 0) {
                    let availableList = document.createElement('ul');
                    availableList.innerHTML = '<strong>Available Items:</strong>';
                    availableItems.forEach(item => {
                        let li = document.createElement('li');
                        li.textContent = `${item.name} - €${item.price.toFixed(2)} x ${item.quantity}`;
                        availableList.appendChild(li);
                    });
                    storeDiv.appendChild(availableList);
                }

                if (unavailableItems.length > 0) {
                    let unavailableList = document.createElement('ul');
                    unavailableList.innerHTML = '<strong>Unavailable Items:</strong>';
                    unavailableItems.forEach(itemName => {
                        let li = document.createElement('li');
                        li.textContent = itemName;
                        unavailableList.appendChild(li);
                    });
                    storeDiv.appendChild(unavailableList);
                }

                totalCostContainer.appendChild(storeDiv);
            }
        }
    });
</script>

{% endblock %}
